### ========================================
### TEST CHá»¨C NÄ‚NG Äáº¶T Cá»ŒC 20,000 VNÄ
### ========================================

# Variables
@host = https://localhost:7035
@token = YOUR_JWT_TOKEN_HERE

### ========================================
### BÆ¯á»šC 1: ÄÄ‚NG NHáº¬P Äá»‚ Láº¤Y TOKEN
### ========================================
POST {{host}}/api/Auth/login
Content-Type: application/json

{
  "email": "chinh22@gmail.com",
  "password": "12345"
}

### LÆ°u token tá»« response vÃ o biáº¿n @token á»Ÿ trÃªn

### ========================================
### BÆ¯á»šC 2: KIá»‚M TRA Sá» DÆ¯ VÃ HIá»†N Táº I
### ========================================
# Xem vÃ­ cÃ³ bao nhiÃªu tiá»n (cÃ³ thá»ƒ qua API wallet hoáº·c xem trong DB)
# Báº¡n cáº§n biáº¿t sá»‘ dÆ° Ä‘á»ƒ quyáº¿t Ä‘á»‹nh test case nÃ o

### ========================================
### TEST CASE 1: Táº O RESERVATION KHI VÃ Äá»¦ TIá»€N (>= 20,000 VNÄ)
### ========================================
# Ká»³ vá»ng: Reservation Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng, 20,000 VNÄ tá»± Ä‘á»™ng trá»« tá»« vÃ­
POST {{host}}/api/reservations
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "pointId": 1,
  "date": "2024-12-25T00:00:00Z",
  "hour": 14
}

# âœ… Response thÃ nh cÃ´ng:
# - reservationId Ä‘Æ°á»£c táº¡o
# - reservationCode Ä‘Æ°á»£c táº¡o
# - 20,000 VNÄ Ä‘Ã£ bá»‹ trá»« tá»« vÃ­
# - Payment record vá»›i ReservationId vÃ  Amount=20000 Ä‘Æ°á»£c táº¡o

### ========================================
### TEST CASE 2: Táº O RESERVATION KHI VÃ KHÃ”NG Äá»¦ TIá»€N (< 20,000 VNÄ)
### ========================================
# TrÆ°á»›c khi test: Äáº£m báº£o vÃ­ cÃ³ < 20,000 VNÄ
# CÃ³ thá»ƒ top-up vÃ­ Ã­t tiá»n hoáº·c dÃ¹ng user cÃ³ Ã­t tiá»n

POST {{host}}/api/reservations
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "pointId": 1,
  "date": "2024-12-26T00:00:00Z",
  "hour": 15
}

# âœ… Response mong Ä‘á»£i:
# Status: 400 Bad Request
# {
#   "message": "VÃ­ khÃ´ng Ä‘á»§ tiá»n Ä‘á»ƒ cá»c. Sá»‘ dÆ° hiá»‡n táº¡i: X VNÄ, Cáº§n: 20000 VNÄ. Vui lÃ²ng thanh toÃ¡n cá»c qua MoMo.",
#   "requiresDepositPayment": true,
#   "depositAmount": 20000,
#   "reservationId": <id>,
#   "paymentMethod": "momo",
#   "action": "Vui lÃ²ng gá»i API /api/payments/reservation-deposit-momo Ä‘á»ƒ thanh toÃ¡n cá»c"
# }
# 
# LÆ°u Ã½: Reservation váº«n Ä‘Æ°á»£c táº¡o nhÆ°ng chÆ°a cÃ³ deposit payment

### ========================================
### TEST CASE 3: THANH TOÃN Cá»ŒC QUA MOMO (Khi vÃ­ khÃ´ng Ä‘á»§)
### ========================================
# ğŸ‘¤ NgÆ°á»i dÃ¹ng thá»±c hiá»‡n - Chá»‰ dÃ¹ng ReservationCode (nháº­n qua email/SMS)
# VÃ­ dá»¥: Sau khi Ä‘áº·t chá»—, vÃ­ khÃ´ng Ä‘á»§, ngÆ°á»i dÃ¹ng thanh toÃ¡n cá»c qua MoMo
POST {{host}}/api/payments/reservation-deposit-momo
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "reservationCode": "KN7BCVXT"
}

# âœ… Response mong Ä‘á»£i:
# Status: 200 OK
# {
#   "message": "Táº¡o payment URL thÃ nh cÃ´ng",
#   "payUrl": "https://test-payment.momo.vn/...",
#   "orderId": "...",
#   "qrCodeUrl": "...",
#   "deeplink": "...",
#   "paymentId": <id>,
#   "reservationId": 123,
#   "depositAmount": 20000
# }

# âš ï¸ LÆ°u Ã½: Cáº§n thanh toÃ¡n trÃªn MoMo sandbox/test Ä‘á»ƒ callback Ä‘Æ°á»£c gá»i
# Sau khi thanh toÃ¡n thÃ nh cÃ´ng, Payment.PaymentStatus sáº½ Ä‘Æ°á»£c update thÃ nh "success"

### ========================================
### TEST CASE 4: KIá»‚M TRA PAYMENT DEPOSIT ÄÃƒ ÄÆ¯á»¢C Táº O
### ========================================
# Kiá»ƒm tra trong database:
# SELECT * FROM Payments WHERE ReservationId = <reservationId> AND Amount = 20000

# Hoáº·c cÃ³ thá»ƒ thÃªm API Ä‘á»ƒ check:
# GET {{host}}/api/payments/reservation/{reservationId}/deposit
# (Cáº§n implement thÃªm endpoint nÃ y náº¿u chÆ°a cÃ³)

### ========================================
### TEST CASE 5: CHECK-IN RESERVATION VÃ€ Táº O SESSION
### ========================================
# Sau khi cÃ³ reservation (Ä‘Ã£ cá»c), check-in Ä‘á»ƒ táº¡o charging session
POST {{host}}/api/reservations/{{reservationCode}}/check-in?initialSOC=20
Authorization: Bearer {{token}}

# âœ… Response mong Ä‘á»£i:
# - Session Ä‘Æ°á»£c táº¡o vá»›i ReservationId Ä‘Æ°á»£c link
# - ChargingSession.ReservationId = ReservationId cá»§a reservation

### ========================================
### TEST CASE 6: THANH TOÃN SESSION CUá»I CÃ™NG (CÃ“ TRá»ª Cá»ŒC)
### ========================================
# Giáº£ sá»­ FinalCost = 50,000 VNÄ
# Deposit = 20,000 VNÄ
# â†’ Chá»‰ cáº§n thanh toÃ¡n thÃªm: 50,000 - 20,000 = 30,000 VNÄ

POST {{host}}/api/payments/pay-by-session
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "sessionId": 456
}

# âœ… Response mong Ä‘á»£i:
# {
#   "message": "Thanh toÃ¡n thÃ nh cÃ´ng. ÄÃ£ trá»« cá»c 20000 VND, thanh toÃ¡n thÃªm 30000 VND",
#   "success": true,
#   "paymentInfo": {
#     "amount": 30000  // Sá»‘ tiá»n thá»±c táº¿ thanh toÃ¡n thÃªm
#   },
#   "walletInfo": {
#     "amountDeducted": 30000  // Chá»‰ trá»« 30k tá»« vÃ­
#   }
# }

### ========================================
### TEST CASE 7: TRÆ¯á»œNG Há»¢P DEPOSIT > FINALCOST (HOÃ€N TIá»€N DÆ¯)
### ========================================
# Giáº£ sá»­ FinalCost = 15,000 VNÄ
# Deposit = 20,000 VNÄ
# â†’ Cáº§n hoÃ n láº¡i: 20,000 - 15,000 = 5,000 VNÄ vÃ o vÃ­

POST {{host}}/api/payments/pay-by-session
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "sessionId": 789
}

# âœ… Response mong Ä‘á»£i:
# {
#   "message": "Thanh toÃ¡n thÃ nh cÃ´ng. ÄÃ£ trá»« cá»c 20000 VND, thanh toÃ¡n thÃªm 0 VND",
#   "success": true,
#   "paymentInfo": {
#     "amount": 15000
#   },
#   "walletInfo": {
#     "amountDeducted": 0  // KhÃ´ng trá»« thÃªm tá»« vÃ­
#   }
# }

# âœ… Kiá»ƒm tra vÃ­ Ä‘Ã£ Ä‘Æ°á»£c hoÃ n 5,000 VNÄ:
# - WalletBalance tÄƒng 5,000 VNÄ
# - WalletTransaction vá»›i type="topup" vÃ  description="HoÃ n tiá»n cá»c dÆ°..."

### ========================================
### TEST CASE 8: KIá»‚M TRA DEPOSIT ÄÃƒ ÄÆ¯á»¢C Sá»¬ Dá»¤NG (KHÃ”NG Bá»Š TRá»ª Láº I)
### ========================================
# Sau khi thanh toÃ¡n session, deposit payment khÃ´ng Ä‘Æ°á»£c trá»« láº¡i
# Chá»‰ cÃ³ 1 payment cho deposit vÃ  1 payment cho session

# Database check:
# SELECT * FROM Payments WHERE ReservationId = <reservationId>
# - 1 payment vá»›i Amount=20000 (deposit)
# - 1 payment vá»›i Amount=<finalCost - 20000> (session payment)

### ========================================
### TEST CASE 9: TRÆ¯á»œNG Há»¢P KHÃ”NG CÃ“ RESERVATION (WALK-IN)
### ========================================
# Session khÃ´ng cÃ³ ReservationId â†’ KhÃ´ng cÃ³ deposit
# Thanh toÃ¡n bÃ¬nh thÆ°á»ng toÃ n bá»™ FinalCost

POST {{host}}/api/payments/pay-by-session
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "sessionId": 999
}

# âœ… Response: Thanh toÃ¡n bÃ¬nh thÆ°á»ng toÃ n bá»™ FinalCost
# KhÃ´ng cÃ³ message vá» deposit

### ========================================
### DEBUGGING TIPS
### ========================================

# 1. Kiá»ƒm tra Payment records:
# SELECT * FROM Payments WHERE ReservationId = <id>

# 2. Kiá»ƒm tra WalletTransactions:
# SELECT * FROM WalletTransactions WHERE UserId = <userId> ORDER BY CreatedAt DESC

# 3. Kiá»ƒm tra ChargingSession cÃ³ ReservationId:
# SELECT * FROM ChargingSessions WHERE ReservationId IS NOT NULL

# 4. Kiá»ƒm tra sá»‘ dÆ° vÃ­:
# SELECT WalletBalance FROM Users WHERE UserId = <userId>

### ========================================
### FLOW HOÃ€N CHá»ˆNH
### ========================================

# 1. User táº¡o reservation â†’ Há»‡ thá»‘ng tá»± Ä‘á»™ng thu 20k tá»« vÃ­ (náº¿u Ä‘á»§)
# 2. Náº¿u vÃ­ khÃ´ng Ä‘á»§ â†’ User pháº£i thanh toÃ¡n qua MoMo
# 3. User check-in reservation â†’ Táº¡o session vá»›i ReservationId
# 4. User sáº¡c xong â†’ Thanh toÃ¡n session
#    - FinalCost = 50k, Deposit = 20k â†’ Chá»‰ thanh toÃ¡n thÃªm 30k
#    - FinalCost = 15k, Deposit = 20k â†’ HoÃ n láº¡i 5k vÃ o vÃ­
#    - KhÃ´ng cÃ³ deposit â†’ Thanh toÃ¡n toÃ n bá»™ FinalCost

